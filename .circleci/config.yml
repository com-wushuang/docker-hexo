version: 2.1
jobs:
  build:
    machine: true
    steps:
      - checkout

      - run: echo "$DOCKER_PASS" | docker login --username $DOCKER_USER --password-stdin

      # build the application image
      - run: docker build -t mystchen/blog:latest .

      # deploy the image
      - run: docker push mystchen/blog:latest

      - add_ssh_keys:
          fingerprints:
            - "1d:5f:b4:39:ce:d7:ec:d2:7c:dd:d1:96:9d:f4:21:33"
      
      - run :
          name: Deploy Over SSH
            command: |
              ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "docker run -d -p 80:80 --name blog mystchen/blog:latest sh /run.sh"      